# コマンドリファレンス

このドキュメントでは、部室予約システムで利用可能なすべてのコマンドについて詳しく説明します。

---

## 🆕 UI/UX仕様（2025年11月更新）

- すべてのDiscord埋め込みメッセージに「部室予約システム | コマンド名」形式のフッターが表示されます。
- `/list`・`/my-reservations`コマンドは「部室予約システム | list | 予約 X/Y」など進捗付きフッターを表示します。
- 予約一覧が10件以上の場合、Ephemeralメッセージ（実行者のみに表示）で複数メッセージに分割して表示されます。
- 予約・一覧・ヘルプ・フィードバックなど、個人情報や操作結果はすべてEphemeralで送信され、プライバシーを保護します。
- 予約情報の表示レイアウトは`/reserve`コマンドのフォーマットに統一されています（Fields, Inline: true/false）。

---

## 📋 目次

- [チャンネルとDMの使い分け](#チャンネルとdmの使い分け)
- [予約管理コマンド](#予約管理コマンド)
  - [/reserve - 予約作成](#reserve---予約作成)
  - [/edit - 予約編集](#edit---予約編集)
  - [/cancel - 予約取り消し](#cancel---予約取り消し)
  - [/complete - 予約完了](#complete---予約完了)
- [表示コマンド](#表示コマンド)
  - [/list - すべての予約を表示](#list---すべての予約を表示)
  - [/my-reservations - 自分の予約を表示](#my-reservations---自分の予約を表示)
- [ユーティリティコマンド](#ユーティリティコマンド)
  - [/help - ヘルプ表示](#help---ヘルプ表示)
  - [/feedback - フィードバック送信](#feedback---フィードバック送信)
- [便利機能](#便利機能)
  - [スマート日時入力](#スマート日時入力)
  - [オートコンプリート](#オートコンプリート)

---

## チャンネルとDMの使い分け

### 使用可能な場所

- **指定チャンネル**: すべてのコマンドが使用可能
- **DM（ダイレクトメッセージ）**: すべてのコマンドが使用可能

### DMから実行した場合の動作

| コマンド | エフェメラル返信<br/>（自分のみ表示） | 公開メッセージ<br/>（全員に表示） |
|---------|-------------------------------------|--------------------------------|
| `/reserve` | ✅ 予約完了確認 | ✅ 指定チャンネルに通知 |
| `/edit` | ✅ 編集完了確認 | ✅ 指定チャンネルに通知 |
| `/cancel` | ✅ 取り消し完了確認 | ✅ 指定チャンネルに通知 |
| `/complete` | ✅ 完了確認 | ✅ 指定チャンネルに通知 |
| `/list` | ✅ DMで表示 | ❌ なし |
| `/my-reservations` | ✅ DMで表示 | ❌ なし |
| `/help` | ✅ DMで表示 | ❌ なし |
| `/feedback` | ✅ DMで表示 | ✅ フィードバックチャンネルに送信 |

**💡 ポイント:**
- DMから予約操作（`/reserve`, `/edit`, `/cancel`, `/complete`）を実行すると、確認メッセージはDMに送られ、公開通知は指定チャンネルに送信されます
- 表示系コマンド（`/list`, `/my-reservations`, `/help`）はDMで完結します
- 他のチャンネルからは使用できません（エラーメッセージが表示されます）

---

## 予約管理コマンド

### /reserve - 予約作成

面接の予約を作成します。

**パラメータ:**
- `date` (必須): 予約日（スマート入力対応）
  - 形式: `YYYY-MM-DD` または `YYYY/MM/DD`
  - 例: `2025-10-15`, `2025/10/15`, `2025/1/5`（自動で`2025/01/05`に正規化）
  - オートコンプリート: 「今日」「明日」「1週間後」などの候補を表示
- `start_time` (必須): 開始時間（スマート入力対応）
  - 形式: `HH:MM` または `H:MM`
  - 例: `14:00`, `9:00`（自動で`09:00`に正規化）
  - オートコンプリート: 09:00〜21:00の30分刻みで候補を表示
- `end_time` (オプション): 終了時間（スマート入力対応）
  - 形式: `HH:MM` または `H:MM`
  - 例: `15:00`, `9:30`（自動で`09:30`に正規化）
  - 省略時: 開始時刻+1時間が自動設定されます
  - オートコンプリート: 開始時刻より後の時刻のみ表示
- `comment` (オプション): コメント
  - 任意のメモや備考を入力できます

**使用例:**
```
/reserve date:2025-10-15 start_time:14:00 end_time:15:00 comment:面接準備あり
```

**動作:**
1. 日付・時刻を自動的に正規化（例: 2025/1/5 → 2025/01/05, 9:00 → 09:00）
2. 過去の日時でないかチェック
3. 時間の重複をチェック（他の予約と重複する場合はエラー）
4. 推測しにくい予約IDを自動生成
5. 予約者には予約IDをプライベートメッセージで通知
6. チャンネルには予約情報を公開通知（IDは含まない）

**通知例:**

*本人のみに見えるメッセージ（🟢 緑色の枠）:*
```
🟢 予約が完了しました！

予約ID: abc123def456
📅 日付: 2025/10/15
🕐 時間: 14:00 - 15:00
� コメント: 面接準備あり
```

*チャンネル全体に見えるメッセージ（🟢 緑色の枠）:*
```
🟢 新しい予約が追加されました

👤 予約者
@ユーザー名
📅 日付          🕐 時間
2025/10/15      14:00 - 15:00
💬 コメント
  面接準備あり
```

---

### /edit - 予約編集

既存の予約を編集します。**自分の予約のみ編集可能**です。

**パラメータ:**
- `reservation_id` (必須): 予約ID
  - オートコンプリート: 自分の保留中の予約が候補として表示されます
- `date` (オプション): 新しい予約日
  - 形式: `YYYY-MM-DD` または `YYYY/MM/DD`
  - 変更しない場合は省略可能
- `start_time` (オプション): 新しい開始時間
  - 形式: `HH:MM` または `H:MM`
  - 変更しない場合は省略可能
- `end_time` (オプション): 新しい終了時間
  - 形式: `HH:MM` または `H:MM`
  - 変更しない場合は省略可能
- `comment` (オプション): 新しいコメント
  - 変更しない場合は省略可能

**使用例:**
```
/edit reservation_id:abc123 date:2025-10-16 start_time:15:00
```

**動作:**
1. 予約の所有者であることを確認
2. 予約が保留中（未完了・未キャンセル）であることを確認
3. 日付・時刻の正規化と過去日時チェック
4. 他の予約との重複チェック（自分の編集中の予約を除く）
5. 変更内容を保存
6. 変更内容を本人にプライベート通知
7. チャンネルに公開通知

**制限:**
- 他のユーザーの予約は編集できません
- 完了済みまたはキャンセル済みの予約は編集できません
- 過去の日付には変更できません
- 終了時刻は開始時刻より後である必要があります

**通知例:**

*本人のみに見えるメッセージ（🟡 黄色の枠）:*
```
🟡 予約を編集しました

🆔  予約ID
abc123
📅 日付
2025/10/15 → 2025/10/16
🕐 時間
14:00-15:00 → 15:00-16:00
```

*チャンネル全体に見えるメッセージ（🟡 黄色の枠）:*
```
🟡 予約が編集されました

@ユーザー名 さんが予約を編集しました
🆔 予約ID
abc123
📅 日付
2025/10/15 → 2025/10/16
🕐 時間
14:00-15:00 → 15:00-16:00
```

---

### /cancel - 予約取り消し

既存の予約を取り消します。

**パラメータ:**
- `reservation_id` (必須): 予約ID
  - オートコンプリート: 自分の保留中の予約が候補として表示されます
- `comment` (オプション): 取り消し理由
  - 任意で取り消しの理由を記載できます

**使用例:**
```
/cancel reservation_id:abc123 comment:都合が悪くなりました
```

**動作:**
1. 予約IDが存在するかチェック
2. 予約のステータスを `cancelled` に変更
3. キャンセル通知をチャンネルに送信

**通知例:**

*本人のみに見えるメッセージ（🔴 赤色の枠）:*
```
🔴 予約を取り消しました

予約ID: abc123
```

*チャンネル全体に見えるメッセージ（🔴 赤色の枠）:*
```
🔴 予約が取り消されました

👤 予約者
@ユーザー名
📅 日付       🕐 時間
2025/10/15   14:00 - 15:00
💬理由
都合が悪くなりました
```

**注意:**
- キャンセル済みの予約は30日後に自動的に削除されます

---

### /complete - 予約完了

予約を完了状態にします。

**パラメータ:**
- `reservation_id` (必須): 予約ID
  - オートコンプリート: 自分の保留中の予約が候補として表示されます
- `comment` (オプション): 完了メモ
  - 任意のメモや感想を入力できます

**使用例:**

```
/complete reservation_id:abc123 comment:面接完了しました
```

**動作:**
1. 予約IDが存在するかチェック
2. 予約のステータスを `completed` に変更
3. 完了通知をチャンネルに送信

**通知例:**

*本人のみに見えるメッセージ（🔵 青色の枠）:*
```
🔵 予約を完了にしました

予約ID: abc123
```

*チャンネル全体に見えるメッセージ（🔵 青色の枠）:*
```
🔵 予約が終わりました

👤 予約者
@ユーザー名
📅 日付      🕐 時間
2025/10/15   14:00 - 15:00
💬 コメント
面接完了しました
```

**注意:**
- 完了済みの予約は30日後に自動的に削除されます
- 終了時刻が過ぎた予約は毎日午前3時に自動的に完了状態になります

---

## 表示コマンド

### /list - すべての予約を表示

すべての予約を一覧表示します。

**パラメータ:** なし

**使用例:**
```
/list
```

**動作:**
1. すべての保留中の予約を取得
2. 日時順にソート
3. **コマンドを実行した人にのみ表示**（他のユーザーには見えません）

**表示例（⚫ 黒色の枠）:**
```
⚫ すべての予約一覧

現在 2 件の予約があります

No.1
👤 予約者
@ユーザーA
📅 日付       🕐 時間
2025/10/15    14:00 - 15:00
💬 コメント
面接準備あり

No.2
👤 予約者
@ユーザーB
📅 日付      🕐 時間
2025/10/16   10:00 - 11:00
```

**プライバシー:**
- このコマンドは**Ephemeral**（一時的）メッセージとして表示されます
- 実行者以外には見えません
- 完了済み・キャンセル済みの予約は表示されません
- ✅ コマンドを打った人にしか見えません
- ✅ 他のユーザーには表示されません
- ✅ すべての予約情報（ID含む）が確認できます

---

### /my-reservations - 自分の予約を表示

自分が作成した予約のみを表示します。

**パラメータ:** なし

**使用例:**
```
/my-reservations
```

**動作:**
1. コマンドを実行したユーザーの保留中の予約のみを取得
2. 日時順にソート
3. **コマンドを実行した人にのみ表示**（他のユーザーには見えません）

**表示例（⚪ 白色の枠）:**
```
⚪ あなたの予約一覧

現在 2 件の予約があります

No.1
🆔 予約ID
abc123
📅 日付       🕐 時間:
2025/10/15   14:00 - 15:00
💬 コメント
面接準備あり

No.2
🆔 予約ID
def456
📅 日付       🕐 時間:
2025/10/16   10:00 - 11:00
```

**プライバシー:**
- ✅ コマンドを打った人にしか見えません
- ✅ 自分の予約のみが表示されます
- ✅ 予約IDが表示されるので、編集・キャンセル・完了に使用できます
- ❌ 完了済み・キャンセル済みの予約は表示されません

---

## ユーティリティコマンド

### /help - ヘルプ表示

コマンド一覧とヘルプメッセージを表示します。

**パラメータ:** なし

**使用例:**
```
/help
```

**動作:**
1. すべてのコマンドの説明を表示
2. 各コマンドのパラメータと使用方法を説明
3. **コマンドを実行した人にのみ表示**（他のユーザーには見えません）

**表示内容:**
- すべてのコマンド (`/reserve`, `/edit`, `/cancel`, `/complete`, `/list`, `/my-reservations`, `/help`, `/feedback`)
- 各コマンドの説明と使用方法
- スマート日時入力とオートコンプリート機能の案内
- パラメータの詳細
- プライバシーに関する情報
- データ管理に関する情報

**プライバシー:**
- ✅ コマンドを打った人にしか見えません
- ✅ チャンネルを汚しません

---

### /feedback - フィードバック送信

システムへのご意見・ご要望を匿名で送信します。

**パラメータ:**
- `message` (必須): フィードバック内容
  - ご意見、ご要望、バグ報告など、自由に記入できます

**使用例:**
```
/feedback message:予約の編集機能があると便利だと思います
```

**動作:**
1. フィードバック内容を受け取る
2. 特定のフィードバックチャンネルに匿名で転送
3. 送信者に確認メッセージを表示
4. **コマンド自体は実行した人にのみ表示**（他のユーザーには見えません）

**送信者に見えるメッセージ:**
```
✅ フィードバックを送信しました

ご意見ありがとうございます。
あなたのフィードバックは匿名で運営チームに届けられました。

今後のシステム改善に活用させていただきます。
```

**フィードバックチャンネルに表示される内容:**
```
💬 新しいフィードバック

予約の編集機能があると便利だと思います

━━━━━━━━━━━━━━━━━━━━
受信日時: 2025-11-09 15:30:00 | 匿名フィードバック
```

**プライバシー:**
- ✅ 完全匿名で送信されます
- ✅ 誰が送信したかは運営チームにも分かりません
- ✅ コマンド実行自体も他のユーザーには見えません
- ✅ ログにはメッセージの長さのみ記録（内容は記録されません）

**注意:**
- `FEEDBACK_CHANNEL_ID` 環境変数が設定されていない場合、このコマンドは使用できません
- 管理者は `.env` ファイルでフィードバックチャンネルを設定する必要があります

---

## 🎯 便利機能

### スマート日時入力

予約作成・編集時の日時入力を、より柔軟に行うことができます。

#### サポートされる日付フォーマット

以下のような様々な形式が自動的に `YYYY/MM/DD` 形式に正規化されます：

| 入力例 | 正規化後 |
|--------|----------|
| `2025/1/5` | `2025/01/05` |
| `2025/1/15` | `2025/01/15` |
| `25/1/5` | `2025/01/05` |
| `2025-01-05` | `2025/01/05` |

**ポイント:**
- 年は2桁（例: `25`）でも4桁（例: `2025`）でもOK
- 月・日は1桁（例: `1/5`）でも2桁（例: `01/05`）でもOK
- スラッシュ（`/`）でもハイフン（`-`）でもOK

#### サポートされる時刻フォーマット

時刻も柔軟な入力が可能で、自動的に `HH:MM` 形式に正規化されます：

| 入力例 | 正規化後 |
|--------|----------|
| `9:00` | `09:00` |
| `9:30` | `09:30` |
| `14:0` | `14:00` |
| `9:5` | `09:05` |

**ポイント:**
- 時は1桁（例: `9:00`）でも2桁（例: `09:00`）でもOK
- 分は1桁（例: `9:5`）でも2桁（例: `09:05`）でもOK
- コロン（`:`）は必須です

#### 過去の日時チェック

予約作成・編集時に、過去の日時を指定するとエラーが表示されます：

```
❌ エラー

過去の日時は指定できません。
指定日時: 2024/12/01 10:00
現在日時: 2025/01/15 14:30

未来の日時を指定してください。
```

---

### オートコンプリート

コマンド入力時に、候補が自動的に表示されます。

#### 日付のオートコンプリート

日付パラメータ入力時に、以下のような候補が表示されます：

- **"今日"** - 今日の日付（例: `2025/01/15`）
- **"明日"** - 明日の日付（例: `2025/01/16`）
- **年の候補** - 現在年と翌年（例: `2025`, `2026`）
- **月の候補** - 年を入力後、月の候補（例: `2025/01`, `2025/02`, ...）
- **日の候補** - 月を入力後、その月の全ての日（例: `2025/01/01`, `2025/01/02`, ...）

**使い方:**
1. `/reserve` や `/edit` で日付入力を開始
2. "今日"や"明日"と入力すると、該当する候補が表示
3. 年（例: `25` や `2025`）を入力すると、年の候補が表示
4. 年/月（例: `2025/1`）を入力すると、その月の日付候補が表示
5. ↑↓キーで選択、Enterで確定

#### 時刻のオートコンプリート

時刻パラメータ入力時に、以下のような候補が表示されます：

- **30分刻み** - `00:00`, `00:30`, `01:00`, `01:30`, ...
- **キリの良い時刻** - `09:00`, `10:00`, `13:00`, `14:00`, ...
- **よく使われる時刻** - `09:00`, `12:00`, `17:00`, `18:00`, ...

**使い方:**
1. `/reserve` や `/edit` で時刻入力を開始
2. 時刻の一部（例: `9`）を入力すると、該当する候補が表示
3. ↑↓キーで選択、Enterで確定

#### 予約IDのオートコンプリート

編集・キャンセル・完了時に、自分の予約IDが自動的に候補として表示されます：

**`/edit` コマンドの場合:**
- 自分の**保留中**の予約のみ表示
- 各候補には日時とコメントも表示されるので選びやすい

**`/cancel` コマンドの場合:**
- 自分の**保留中**の予約のみ表示
- キャンセル可能な予約のみが候補に

**`/complete` コマンドの場合:**
- 自分の**保留中**の予約のみ表示
- 完了可能な予約のみが候補に

**表示例:**
```
予約ID候補:
━━━━━━━━━━━━━━━━━━━━
abc123 - 2025/01/15 14:00-15:00 | 面接準備あり
def456 - 2025/01/16 10:00-11:00 | 会議室予約
```

**使い方:**
1. `/edit`, `/cancel`, `/complete` コマンドを実行
2. `reservation_id` パラメータをクリック
3. 自分の予約一覧が表示される
4. ↑↓キーで選択、Enterで確定
5. 予約IDが自動入力される

---

## 🔒 プライバシーに関する注意事項

### コマンドを打った人にしか見えないコマンド
以下のコマンドは、実行した人にのみメッセージが表示されます（Ephemeralメッセージ）：

- `/list` - すべての予約を表示
- `/my-reservations` - 自分の予約を表示
- `/help` - ヘルプ表示
- `/feedback` - フィードバック送信

これらのコマンドを実行しても、チャンネルには何も表示されず、他のユーザーに通知されることはありません。

### 予約IDの取り扱い
- 予約作成時、予約IDは**予約者本人にのみ**プライベートメッセージで通知されます
- チャンネルに表示される公開通知には予約IDは含まれません
- 予約IDは推測しにくいランダムな文字列で生成されます

### フィードバックの匿名性
- `/feedback` コマンドで送信されたメッセージは完全に匿名化されます
- 送信者の情報（ユーザーID、ユーザー名など）は一切含まれません
- ログにはメッセージの長さのみが記録され、内容は保存されません

---

## 🗑️ データ管理

### 自動クリーンアップ
- **完了済み・キャンセル済みの予約**: 30日後に自動削除
- **期限切れの予約**: 毎日午前3時に自動完了

詳細は [CLEANUP.md](CLEANUP.md) を参照してください。

### 手動での削除
現時点では、予約の手動削除機能はありません。予約を削除したい場合は、`/cancel` コマンドでキャンセルしてください。キャンセルされた予約は30日後に自動的に削除されます。

---

## 💡 よくある質問

### Q: 予約IDを忘れてしまいました
A: `/my-reservations` コマンドで自分の予約を確認できます。予約IDも表示されます。

### Q: 他の人の予約IDを見ることはできますか？
A: 見ることはできません。

### Q: 予約を編集することはできますか？
A: はい、`/edit` コマンドで予約の編集ができます。日付、開始時間、終了時間、コメントを個別に変更可能です。ただし、自分の予約のみ編集でき、保留中の予約のみ対象です。

### Q: フィードバックを送信したことは他の人に分かりますか？
A: いいえ、`/feedback` コマンド自体があなたにしか見えないため、誰にも分かりません。

### Q: 予約の時間が重複するとどうなりますか？
A: エラーメッセージが表示され、予約は作成されません。別の時間を選択してください。

---

## 🛠️ 管理者向け情報

### 環境変数の設定

フィードバック機能を有効にするには、`.env` ファイルに以下を追加してください：

```env
FEEDBACK_CHANNEL_ID=your_feedback_channel_id_here
```

フィードバックチャンネルIDの取得方法：
1. Discordの設定で「開発者モード」を有効化
2. フィードバックを受け取りたいチャンネルを右クリック
3. 「IDをコピー」を選択
4. `.env` ファイルに貼り付け

### コマンドの登録

新しいコマンド（`/help` と `/feedback`）は、Botを再起動すると自動的に登録されます。

```bash
make run  # または go run cmd/bot/main.go
```

GUILD_IDが設定されている場合は即座に反映されます。グローバルコマンドの場合は最大1時間かかります。

---

## 📚 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要とセットアップ
- [QUICKSTART.md](QUICKSTART.md) - クイックスタートガイド
- [CLEANUP.md](CLEANUP.md) - クリーンアップ機能の詳細
- [DEVELOPMENT.md](DEVELOPMENT.md) - 開発者向けガイド
