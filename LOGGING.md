# ログシステム仕様書

## 概要

このDiscord Bot予約システムには、1か月のコマンドログを`.log`ファイルに記録し、コマンドの総数をJSONファイルに書き込む機能が実装されています。

## 機能

### 1. コマンドログ記録
- すべてのDiscordコマンド実行をログに記録
- タイムスタンプ、コマンド名、ユーザー情報、成功/失敗状態を含む
- パラメータ情報も記録

### 2. 月次ログローテーション
- 毎月自動的に新しいログファイルを作成
- ファイル名形式: `commands_YYYY-MM.log`
- 例: `commands_2025-01.log`

### 3. 統計情報管理
- コマンド総数をJSONファイルに保存
- コマンド別、ユーザー別の統計情報
- 月別統計も記録

## ファイル構造

```
logs/
├── command_stats.json          # 統計情報（JSON形式）
├── commands_2025-01.log       # 2025年1月のログ
├── commands_2025-02.log       # 2025年2月のログ
└── ...
```

## ログファイル形式

### 月次ログファイル（.log）
各行がJSON形式のログエントリ：

```json
{
  "timestamp": "2025-01-15T14:30:00Z",
  "command": "reserve",
  "user_id": "123456789012345678",
  "username": "ユーザー名",
  "channel_id": "987654321098765432",
  "success": true,
  "error": "",
  "parameters": {
    "date": "2025-01-20",
    "start_time": "14:00",
    "end_time": "15:00",
    "comment": "面接の予約"
  }
}
```

### 統計ファイル（command_stats.json）
```json
{
  "total_commands": 150,
  "command_counts": {
    "reserve": 45,
    "cancel": 12,
    "complete": 38,
    "list": 30,
    "my-reservations": 25
  },
  "user_counts": {
    "123456789012345678": 25,
    "987654321098765432": 18
  },
  "last_updated": "2025-01-15T14:30:00Z",
  "monthly_stats": {
    "2025-01": {
      "year": 2025,
      "month": 1,
      "total_commands": 150,
      "command_counts": {...},
      "user_counts": {...}
    }
  }
}
```

## 自動化機能

### 1. ログローテーション
- 月が変わるたびに自動的に新しいログファイルを作成
- 古いログファイルは保持される

### 2. 古いログのクリーンアップ
- 1日1回、1か月以上前のログファイルを自動削除
- ディスク容量の節約

### 3. 統計の自動更新
- コマンド実行のたびに統計情報を更新
- 5分ごとにファイルに保存

## 使用方法

### ログの確認
```bash
# 現在の月のログを確認
tail -f logs/commands_2025-01.log

# 特定のコマンドのログを検索
grep '"command":"reserve"' logs/commands_2025-01.log

# エラーログのみを表示
grep '"success":false' logs/commands_2025-01.log
```

### 統計情報の確認
```bash
# 統計ファイルを表示
cat logs/command_stats.json | jq .

# 総コマンド数を確認
cat logs/command_stats.json | jq '.total_commands'

# コマンド別統計を確認
cat logs/command_stats.json | jq '.command_counts'
```

## 設定

### ログディレクトリの変更
`main.go`の以下の行を変更：
```go
logger = logging.NewLogger("./logs")  // デフォルト: ./logs
```

### クリーンアップ期間の変更
`logging/logger.go`の`CleanupOldLogs`関数内の`cutoffDate`を変更：
```go
cutoffDate := time.Now().AddDate(0, -1, 0) // 1か月前
```

## 監視とメンテナンス

### 1. ログファイルサイズの監視
```bash
# ログディレクトリのサイズを確認
du -sh logs/

# 各ログファイルのサイズを確認
ls -lh logs/*.log
```

### 2. 統計情報の定期確認
- 統計ファイルはリアルタイムで更新される
- 異常な値がないか定期的に確認

### 3. ログローテーションの確認
- 月の変わり目に新しいログファイルが作成されることを確認
- 古いログファイルが適切に削除されることを確認

## トラブルシューティング

### ログファイルが作成されない
1. `logs`ディレクトリの権限を確認
2. ディスク容量を確認
3. アプリケーションのログを確認

### 統計が更新されない
1. 統計ファイルの権限を確認
2. JSONファイルの形式が正しいか確認
3. アプリケーションのエラーログを確認

### 古いログが削除されない
1. ファイルの権限を確認
2. ファイル名の形式が正しいか確認
3. クリーンアップ機能が動作しているか確認

## セキュリティ考慮事項

1. **ログファイルの権限**: ログファイルは適切な権限（644）で作成される
2. **機密情報**: パスワードやトークンなどの機密情報はログに記録されない
3. **ログローテーション**: 古いログは自動的に削除される
4. **アクセス制御**: ログディレクトリへのアクセスを適切に制限する

## パフォーマンス考慮事項

1. **非同期ログ記録**: ログ記録は非同期で実行される
2. **バッファリング**: ログはバッファリングされて効率的に書き込まれる
3. **定期的な保存**: 統計情報は定期的に保存される
4. **メモリ使用量**: ログデータはメモリに保持されない

このログシステムにより、Discord Botの使用状況を詳細に追跡し、統計情報を管理することができます。


